# **移動アルゴリズム ビジュアライザー 開発仕様書 (for Claude)**

## **1\. はじめに**

### **1.1. 本ドキュメントの目的**

このドキュメントは、SNSアプリ「Logi-Post」のコア機能である「移動アルゴリズム」の挙動を視覚化するツール「移動アルゴリズム ビジュアライザー」の開発仕様を定義するものです。Claude Codeがこの仕様書を読み込み、直接開発作業に着手できるレベルの詳細情報を提供します。

### **1.2. アプリ「Logi-Post」のコンセプト**

- **コンセプト**: 「日本の物流が、誰かの想いを運ぶ道になる」 \[cite: 5-9\]
- **概要**: ユーザーが作成したデジタル絵葉書が、実際の物流データに基づいて日本中を旅していく非同期型SNSです。届け先を指定せず、「ボトルメール」のように誰に届くかわからないワクワク感と、自分の投稿が日本のどこかを旅している様子を眺める楽しさを提供します。
- **目的**: 統計データの新しい価値創出、地方ユーザーも楽しめる体験の創出、そして偶然の出会いによる新しいコミュニケーションの形を提案します。 \[cite: 5-9\]

### **1.3. ビジュアライザー開発の背景**

移動アルゴリズムは本アプリの体験の根幹をなす複雑なロジックです。パラメータの調整やロジックの改善がサービスの質を大きく左右するため、チームメンバー全員がその挙動を直感的に理解し、改善の議論を活発に行える環境が必要です。本ツールはそのための共通基盤となります。

## **2\. Logi-Post移動アルゴリズムの全体像**

絵葉書の「旅」は、以下の2つのアルゴリズムの組み合わせで実現されます。

1. **目的県決定アルゴリズム (今回は手動設定)**:
   - **役割**: 絵葉書の最終的な目的地となる「都道府県」を決定します。
   - **現状**: 現在、複数の案を検討中のため、**今回のビジュアライザーではこの部分を「ユーザーの手動選択」で代替します。**
2. **ルート決定アルゴリズム (今回のビジュアライズ対象)**:
   - **役割**: 出発地と目的県が与えられた際に、その間を経由する具体的な「市区町村」のルートを生成します。
   - **特徴**: 「市区町村別来訪者数」データを重みとして活用し、多くの人が訪れる人気の場所などを巡るリアルな旅を演出します。

## **3\. ビジュアライズ対象アルゴリズム：ルート決定仕様**

本ツールで実装・可視化するアルゴリズムの詳細です。

- **入力**:
  1. startPref (出発地の都道府県名, String)
  2. endPref (目的地の都道府県名, String)
  3. numStops (経由地の数, Integer)
- **出力**: route (経由する市区町村オブジェクトのリスト, Array of Objects) \- 各オブジェクトは {name, lat, lon} を含む。
- **ロジック**:
  1. **初期化**: ルートリスト route を作成し、出発地の県庁所在地（または代表市区町村）を追加します。currentLocation（現在地）をこの市区町村に設定します。
  2. 経由地決定ループ: numStops の回数だけ、以下の処理を繰り返します。
     a. 候補の絞り込み:
     \- すべての市区町村の中から、currentLocation よりも目的地（endPrefの中心緯度経度）に物理的に近くなる市区町村のみを候補 candidates としてリストアップします。
     b. 確率的選択:
     \- 絞り込んだ候補 candidates の中から、「市区町村別来訪者数（人数）」を重み（weight）として、次の経由地をランダムに1つ選択します。
     c. ルート更新:
     \- 選択した市区町村をルートリスト route に追加し、currentLocation をその市区町村に更新します。
  3. **完了**: 最後に目的地の県庁所在地をルートリスト route に追加して、最終的なルートを返します。

## **4\. ビジュアライザーの技術仕様**

### **4.1. 実行環境**

- モダンブラウザ (Google Chrome, Mozilla Firefox, Microsoft Edge)
- 特定のWebサーバーは不要。ローカルのindex.htmlファイルを直接ブラウザで開いて実行できる単一ファイルアプリケーションとして構築します。

### **4.2. 推奨技術・ライブラリ**

- **言語**: HTML, CSS, JavaScript (ES6+)
- **地図ライブラリ**: [Leaflet.js](https://leafletjs.com/) \- オープンソースで軽量なインタラクティブマップライブラリ。
  - CDN: \<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"\>\</script\>
- **CSVパーサー**: [Papa Parse](https://www.papaparse.com/) \- ブラウザ上でCSVファイルを簡単に扱えるようにするライブラリ。
  - CDN: \<script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"\>\</script\>

## **5\. データ要件**

ビジュアライザーを実行するために、以下の2つのデータファイルをローカルに配置して使用します。（dataディレクトリなどを想定）

### **5.1. 市区町村別来訪者数データ**

- **ファイル**: city202507.csv
- **内容**: 各市区町村の観光来訪者数。ルート生成時の重みとして使用します。
- **必須カラム**: 都道府県名, 地域名称, 人数

### **5.2. 市区町村 位置情報データ**

- **ファイル**: city_location.csv
- **内容**: 各市区町村の緯度・経度情報。
- **必須カラム**: 地域名称, 緯度, 経度

### **5.3. データ結合処理**

- **処理**: アプリケーションの初期化時に、上記2つのCSVファイルを読み込みます。その後、「地域名称」をキーとして2つのデータを結合し、アルゴリズムで利用可能な単一のデータ構造（オブジェクト配列）を生成します。
- **結合後のデータ構造（例）**:
  \[
  { "都道府県名": "北海道", "地域名称": "札幌市中央区", "人数": 582347, "緯度": 43.055, "経度": 141.341 },
  ...
  \]

## **6\. 画面設計と機能仕様**

画面は「コントロールパネル」と「マップビュー」の2つの領域で構成します。

### **6.1. 画面設計 (UI)**

- **全体レイアウト**:
  - FlexboxやGrid Layoutを使用し、左側にコントロールパネル（幅約30%）、右側にマップビュー（幅約70%）を配置します。
- **コントロールパネル (\<div id="controls"\>)**:
  - **出発地の県**: ドロップダウンリスト (\<select id="start-pref"\>)
  - **目的地の県**: ドロップダウンリスト (\<select id="end-pref"\>)
  - **経由地の数**: スライダー (\<input type="range" id="num-stops" min="3" max="10"\>) と、選択中の数値を表示する \<span\> (\<span id="stops-value"\>)
  - **実行ボタン**: ボタン (\<button id="generate-button"\>) ラベル：「ルート生成」
  - **結果表示エリア**: テキストエリア (\<textarea id="result-text" readonly\>)
- **マップビュー (\<div id="map"\>)**:
  - 地図表示用のコンテナ。高さはビューポートに合わせます（例: height: 100vh）。

### **6.2. 機能仕様**

- **初期化処理**:
  1. ページの読み込み完了後、city202507.csv と city_location.csv を非同期で読み込み、パースします。
  2. **5.3.で定義した結合処理**を行い、単一の市区町村データ配列をグローバル変数に保持します。
  3. 結合後のデータから都道府県リストを動的に生成し、出発地・目的地のドロップダウンリストを初期化します。
  4. Leaflet.jsを用いて、日本の地図をマップビューに初期表示します。
- **「ルート生成」ボタンのクリックイベント**:
  1. コントロールパネルから各パラメータ（出発県、目的県、経由地数）を取得します。
  2. これらのパラメータを引数として、後述のgenerateRoute()関数を呼び出します。
  3. generateRoute()から返されたルート情報（市区町村オブジェクトのリスト）をdrawMap()関数に渡します。
  4. 結果表示エリアに、経由する市区町村名を番号付きリストとして表示します。

## **7\. 実装ガイドライン**

- **シングルファイル構成**: 開発の容易さを考慮し、HTML, CSS, JavaScriptを単一のindex.htmlファイルにまとめてください。
- **関数の分離**: ロジックを明確に分離するため、以下の主要な関数を実装してください。
  - init(): データの読み込み、結合、UIの初期化など、ページロード時に一度だけ実行する処理をまとめます。
  - generateRoute(startPref, endPref, numStops): **3章で定義したアルゴリズム**を実装する純粋な関数です。UIに依存せず、入力に基づいてルート情報の配列を返す責務を持ちます。
  - drawMap(route): generateRouteが返したルート情報を受け取り、Leafletのマップ上にマーカーと線を描画する責務を持ちます。描画前には必ず既存の描画をクリアしてください。
- **アルゴリズム内のヘルパー関数**:
  - getDistance(lat1, lon1, lat2, lon2): 2点間の距離を計算する関数を別途作成すると、ロジックがクリーンになります。
- **コメント**: アルゴリズムのコアロジック（特に候補の絞り込み、重み付け選択の部分）には、処理内容が理解しやすいように詳細なコメントを付与してください。
- **県庁所在地の扱い**:
  - ルートの始点・終点となる県庁所在地の緯度経度は、結合後のデータの中から代表的な市区町村（例：東京都→新宿区、愛知県→名古屋市中区）のデータを検索して使用してください。
